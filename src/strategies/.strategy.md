
---

# Aave Tokenized Strategy — Variants Design & Implementation Plan

**Scope**
Full design and implementation plan (architecture, interfaces, security, testing, deployment, monitoring, governance, and gas analysis) for five strategy variants built on top of the `AaveV3Lender` tokenized strategy:

1. Leveraged looping strategy (configurable 1×–5×)
2. Morpho Blue strategy (Morpho adapter replacement)
3. Spark strategy (Spark pool integration)
4. Multi-lender router (Aave + Morpho + Spark allocation router)
5. Pendle-boosted Aave (deposit aTokens into Pendle PT/LP for boosting)

This document assumes `AaveV3Lender` (inherits `BaseStrategy`) as the baseline implementation.

---

## Table of Contents

1. Goals & requirements
2. High-level architecture
3. Shared primitives & reusable interfaces
4. Strategy variants (detailed design)
5. Multi-lender router specification
6. Pendle boosting design
7. Audit & verification checklist
8. Gas / cost analysis
9. Deployment rollout plan
10. Monitoring & observability
11. Emergency & ops playbook
12. Repo structure & CI recommendations
13. Example Foundry tests
14. Appendix (ABIs, interfaces, pseudocode)

---

## 1) Goals & Requirements

**Primary goal**
Provide safe, modular, auditable lending strategies that plug into a TokenizedStrategy vault and can be combined or boosted without breaking risk boundaries.

**Non-functional goals**

* Reusable: shared interfaces, minimal divergence between variants
* Safe: liquidation-resistant, predictable behavior, emergency paths
* Auditable: explicit math, no hidden state, single-responsibility functions
* Observable: clear on-chain view functions + off-chain monitoring hooks
* Configurable: leverage caps, allocation %, reward sell thresholds, etc.

**Roles**

| Role        | Permissions                                                                |
| ----------- | -------------------------------------------------------------------------- |
| Governance  | Timelocked control of high-risk params (max leverage, approve new lenders) |
| Management  | Routine ops (fee set, unpause, set min sell)                               |
| Strategist  | Adjust strategy logic within governance limits                             |
| Keeper bots | Automated harvest, rebalance, deleverage                                   |

Security assumption: underlying protocols (Aave, Morpho, Spark) are canonical, audited, and use trusted price feeds.

---

## 2) High-Level Architecture

**Core components**

* `BaseStrategy` – ERC-4626 wrapper, accounting, reporting
* `AaveV3Lender` – baseline single-lender implementation
* `LeveragedLoopStrategy` – borrows & redeposits to reach target leverage
* `MorphoAdapter` / `SparkAdapter` – protocol swap-ins implementing same interface
* `MultiLenderRouter` – manages allocations across multiple strategies
* `PendleBooster` – optional Aave aToken → Pendle PT/LP layer
* Off-chain keepers – harvest, rebalance, deleverage calls

**Flow overview**

```
User → Vault (ERC4626) → Tokenized Strategy
        ↳ Aave
        ↳ Morpho
        ↳ Spark
        ↳ (optional) Pendle booster
```

---

## 3) Shared Primitives & Interfaces

Minimal lending abstraction:

```solidity
interface IYieldSource {
    function supply(address asset, uint256 amount) external;
    function withdraw(address asset, uint256 amount, address to) external returns (uint256);
    function getLiquidity(address asset) external view returns (uint256);
    function claimRewards(address to) external returns (address[] memory rewards);
}
```

Adapters: `AaveAdapter`, `MorphoAdapter`, `SparkAdapter` all implement this.

Shared util libs:

* Math helpers
* Accounting helpers
* Harvest handling utility

Role modifiers reused: `onlyGovernance`, `onlyManagement`, `onlyStrategist`.

---

## 4) Strategy Variants (Summary)

### A. Leveraged Looping Strategy

Borrow + redeposit loop to reach target leverage (2×–5×), strictly capped by governance and health factor guardrails.

### B. Morpho Blue Strategy

Drop-in replacement for Aave calls using Morpho supply/withdraw model.

### C. Spark Strategy

Identical pattern, new adapter pointing to Spark pool.

### D. Multi-Lender Router

Single strategy that allocates across multiple child strategies with dynamic % weights, rebalance logic, and failure isolation.

### E. Pendle-Boosted Aave

After supplying to Aave, deposit aTokens into Pendle to receive PT/LP for boosted yield with optional partial boosting.

---

## 5) Multi-Lender Router (Detailed)

* Tracks list of child strategies + allocation %
* Splits deposit across children
* Withdraws proportionally or from most liquid first
* Rebalancing: reallocates when drift > threshold
* Emergency: governance can zero-out a child and recall all funds

Core storage:

```solidity
struct Child {
    address strategy;
    uint256 allocBps;
    bool active;
}
Child[] public children;
```

---

## 6) Pendle Boosting (Detailed)

Modes:

| Mode    | Description                        |
| ------- | ---------------------------------- |
| FULL    | All aTokens boosted into Pendle    |
| PARTIAL | % boosted, rest stays idle in Aave |

Handles PT maturity, selling, or holding to expiry.

---

## 7) Audit & Verification Checklist

* Bounded loops only (maxIterations)
* Reentrancy guards
* No underflow/over-reporting of `totalAssets()`
* Emergency exit always available
* Governance changes timelocked
* Approvals minimized and revoked on exit

---

## 8) Gas / Cost Notes

* Leveraged loops = most expensive (multiple borrow/supply)
* Router rebalances scale with number of children
* Pendle interactions moderate gas, market-dependent

---

## 9) Deployment Plan

1. Build + test adapters
2. Local unit tests
3. Mainnet fork integration tests
4. Internal audit
5. Testnet deployment + sim TVL
6. Small-TVL guarded launch
7. Scale with monitoring + alerts

---

## 10) Monitoring & Metrics

Expose:

* `totalAssets()`
* `healthFactor()` (leveraged only)
* `currentLeverage()`
* `pendingRewards()`
* `availableWithdrawLimit()`

Alerts:

* HF < threshold
* Rebalance overdue
* Harvest failure

---

## 11) Emergency Playbook

* `pause()` (management)
* `shutdown()` (governance) → full unwind + return to vault
* Router: set alloc = 0 and withdraw child funds
* Forced deleverage callable by anyone if HF drops too low

---

## 12) Repo Structure

```
/contracts
  /adapters
  /strategies
  /periphery
/tests
/scripts
/CI
```

CI: Foundry tests, mainnet-fork tests, static analysis.

---

## 13) Example Tests

* Looping: deposit → reach 3× → rate change → forced deleverage
* Router: add/remove child, rebalance under stress
* Pendle: simulate expiry + settlement

---

## 14) Appendix

* Key interface snippets
* Leverage math
* Unwind pseudocode
* Child accounting example

---

